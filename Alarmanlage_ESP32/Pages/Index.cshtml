@page
@model IndexModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class="row">
    <div class="col-12 mb-4">
        <h2 class="display-6 fw-bold text-dark">Übersicht</h2>
        <p class="text-secondary">Echtzeit-Daten aus dem Wohnzimmer</p>
    </div>
</div>

<div class="dashboard-grid">
    
    <!-- Temperatur -->
    <div class="sensor-card">
        <div class="card-header-icon">
            <span class="card-label">Temperatur</span>
            <span class="material-icons-round" style="color: #FF5722; background: rgba(255,87,34,0.1);">thermostat</span>
        </div>
        <div class="card-value">
            <span id="temp">@Model.Temp</span><span class="unit">°C</span>
        </div>
    </div>

    <!-- Luftfeuchtigkeit -->
    <div class="sensor-card">
        <div class="card-header-icon">
            <span class="card-label">Luftfeuchtigkeit</span>
            <span class="material-icons-round" style="color: #00BCD4; background: rgba(0,188,212,0.1);">water_drop</span>
        </div>
        <div class="card-value">
            <span id="hum">@Model.Hum</span><span class="unit">%</span>
        </div>
    </div>

    <!-- Bewegung -->
    <div class="sensor-card">
        <div class="card-header-icon">
            <span class="card-label">Bewegung</span>
            <span class="material-icons-round" style="color: #673AB7; background: rgba(103, 58, 183, 0.1);">directions_run</span>
        </div>
        <div class="card-value">
            <span id="motion">@Model.Motion</span>
        </div>
    </div>

    <!-- Licht -->
    <div class="sensor-card">
        <div class="card-header-icon">
            <span class="card-label">Lichtsensor</span>
            <span class="material-icons-round" style="color: #FFC107; background: rgba(255, 193, 7, 0.1);">light_mode</span>
        </div>
        <div class="card-value">
            <span id="light">@Model.Light</span>
        </div>
    </div>

    <!-- Alarm Status -->
    <div class="sensor-card alarm-card" id="alarmCard">
        <div class="card-header-icon">
            <span class="card-label">Sicherheitsstatus</span>
            <span class="material-icons-round" id="alarmIcon">notifications_none</span>
        </div>
        <div class="card-value">
            <span id="alarm">@Model.Alarm</span>
        </div>
    </div>
</div>

<div class="row mb-5">
    <div class="col-md-4 offset-md-4">
        <form method="post" asp-page-handler="DisableAlarm">
            <button type="submit" class="btn-disable-alarm">
                <span class="material-icons-round">gpp_good</span>
                Alarm deaktivieren
            </button>
        </form>
    </div>
</div>

<div class="history-section">
    <div class="section-title">
        <span class="material-icons-round text-secondary">history</span>
        Ereignisprotokoll
    </div>
    <div class="history-list" id="historyContainer">
        <div id="historyBody">
            @foreach (var log in IndexModel.History)
            {
                <div class="history-item">
                    <span class="time-badge">@log.Substring(0, 8)</span>
                    <span class="data-content">@log.Substring(11)</span>
                </div>
            }
        </div>
    </div>
</div>

<script>
    async function fetchData() {
        try {
            const response = await fetch(window.location.href);
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const updateText = (id) => {
                const el = document.getElementById(id);
                const newEl = doc.getElementById(id);
                if (el && newEl) el.innerText = newEl.innerText;
                return newEl ? newEl.innerText : "";
            };

            updateText('temp');
            updateText('hum');
            updateText('motion');
            updateText('light');
            const alarmVal = updateText('alarm');

            const alarmCard = document.getElementById('alarmCard');
            const alarmIcon = document.getElementById('alarmIcon');
            
            if (alarmVal !== "0" && alarmVal !== "--") {
                alarmCard.classList.add('alarm-active');
                alarmIcon.innerText = "notifications_active";
            } else {
                alarmCard.classList.remove('alarm-active');
                alarmIcon.innerText = "notifications_none";
            }

            const currentHistory = document.getElementById('historyBody');
            const newHistory = doc.getElementById('historyBody');
            if(currentHistory && newHistory && currentHistory.innerHTML !== newHistory.innerHTML) {
                currentHistory.innerHTML = newHistory.innerHTML;
            }

        } catch (error) {
            console.error("Verbindungsfehler...", error);
        }
    }

    setInterval(fetchData, 2000);
</script>